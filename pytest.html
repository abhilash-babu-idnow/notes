<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Abhilash" />
  <title>Pytest Notes</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="sakura-dark-solarized.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Pytest Notes</h1>
<p class="author">Abhilash</p>
</header>
<hr />
<h3 id="test-discovery">Test discovery</h3>
<p><strong>pytest</strong> finds which tests to run.</p>
<p>conventions:</p>
<ul>
<li>Test files should be named test_&lt;something&gt;.py or &lt;something&gt;_test.py</li>
<li>Test methods and functions should be named test_&lt;something&gt;</li>
<li>Test classes should be named Test&lt;Something&gt;</li>
</ul>
<blockquote>
<p><strong>session</strong> - one invocation of pytest, including all of the tests run on possibly multiple directories. <strong>rootdir</strong> - top most common directory to all of the directories being searched for test code. <strong>configuration files</strong> - <strong>pytest.ini</strong> or <strong>tox.ini</strong> or <strong>setup.cfg</strong></p>
</blockquote>
<hr />
<h3 id="executing-tests">Executing tests</h3>
<h4 id="running-only-one-test.">Running only one test.</h4>
<pre><code>pytest -v test_&lt;somefile&gt;.py::test_&lt;somefunc&gt;</code></pre>
<h4 id="useful-command-line-flags-are">Useful command line flags are</h4>
<ul>
<li>-collect-only : shows which tests will be run with the given options and configuration.</li>
<li>-k : use an expresion to find what test functions to run</li>
<li>-m : use mark expression to choose the tests with marks</li>
<li>-x : exit on first failure</li>
<li>-s : no capture</li>
<li>–lf : rerun only the tests that failed last time</li>
<li>–ff : run all tests but run the last failed first</li>
<li>-v : verbose</li>
<li>-q : quiet</li>
<li>–tb=auto/long/short/line/native/no : traceback</li>
</ul>
<hr />
<h1 id="chapter-2---writing-test-functions">Chapter 2 - Writing Test Functions</h1>
<p>Goals : * write test functions * organize tests into classes, modules and directories. * usage of markers and builtin markers * test parameterization.</p>
<p>For the example test project, the unit tests and functional tests are placed in separate folders under the tests directory. The files <em><strong>init</strong>.py</em> under the <em>func</em> and <em>unit</em> folder are empty. Add it is an indication to <strong>pytest</strong> that it should go up one directory to look for the root of the test directory and look for the pytest.ini file.</p>
<blockquote>
<p><strong>pytest.ini</strong> file is optional and contains project wide pytest configuration such as setting up the list of options that will be always used.</p>
</blockquote>
<blockquote>
<p><strong>conftest.py</strong> acts like a local plugin for pytest and contains hook functions and fixtures. Hook functions insert code to alter the working of pytest. Fixtures are set up and tear down functions that run before and after the tests.</p>
</blockquote>
<h3 id="using-assert-statements">Using assert statements</h3>
<p>Normal Python <strong>assert</strong> statement is used to communicate test failure.</p>
<blockquote>
<p>assert &lt;expression&gt; If the expression evaluates to <strong>False</strong> then the test would fail.</p>
</blockquote>
<p>In verbose mode, pytest will also show where exactly the assertion failed.</p>
<hr />
<h3 id="expecting-exceptions">Expecting Exceptions</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">def</span> test_with_exception():</a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="co">&quot;&quot;&quot; somefunc should raise TypeError &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="cf">with</span> pytest.raises(<span class="pp">TypeError</span>):</a>
<a class="sourceLine" id="cb2-6" title="6">        somefunct()</a></code></pre></div>
<p>pytest will report failure if somefunc doesn’t raise the TypeError. We can also check the execption message.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">def</span> test_exception_msg():</a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="co">&quot;&quot;&quot; test the exception message &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>) <span class="im">as</span> excinfo:</a>
<a class="sourceLine" id="cb3-6" title="6">        somefunc()</a>
<a class="sourceLine" id="cb3-7" title="7">    exception_msg <span class="op">=</span> excinfo.value.args[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb3-8" title="8">    <span class="cf">assert</span> exception_msg <span class="op">==</span> <span class="st">&quot;expected exception message&quot;</span></a></code></pre></div>
<h3 id="marking-test-functions">Marking test functions</h3>
<p>A test can have more than one marker. A marker can be on multiple tests.</p>
<h3 id="skipping-test-functions">Skipping test functions</h3>
<p>There are three builtin markers to skip the tests: <em>skip</em>, <em>skipif</em> an <em>xfail</em>.</p>
<p>You can skip a test by setting the marker like this</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="at">@pytest.mark.skip</span>(reason<span class="op">=</span><span class="st">&quot;some reason&quot;</span>)</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">def</span> test_skipped_test():</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="co">&quot;&quot;&quot; some test that needs to be skipped</span></a></code></pre></div>
<p>You can also do conditional skipping of the tests like this. In the code below <em>somecondition</em> is any valid Python expression.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="at">@pytest.mark.skipif</span>(somecondition, reason<span class="op">=</span><span class="st">&quot;somecondition is not satisfied&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">def</span> test_skip_cond_test():</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="co">&quot;&quot;&quot; some test that will be skipped based on some condition &quot;&quot;&quot;</span></a></code></pre></div>
<blockquote>
<p>In order to see the reason for skipping, use the command line option -rs.</p>
</blockquote>
<h3 id="marking-tests-as-expecting-to-fail.">Marking tests as expecting to fail.</h3>
<p><strong><span class="citation" data-cites="todo">@todo</span></strong></p>
<h3 id="running-a-subset-of-tests.">Running a subset of tests.</h3>
<ul>
<li>Single Directory - use directory as the paramter to pytest</li>
<li>Single Test file/module - use file with relative path as paramter to pytest</li>
<li>Single Test class - use file with relative path followed by :: and class name</li>
<li>Single Test method of a test class - use file with relative path followed by ::, classname, :: and test method name.</li>
<li>Set of Tests based on test name - use the command line option -k, for example ‘-k raises’ will run all the functions with raises in their name</li>
</ul>
<h3 id="parametrized-testing">Parametrized Testing</h3>
<p><strong><span class="citation" data-cites="todo">@todo</span></strong></p>
<h1 id="chapter-3---fixtures">Chapter 3 - Fixtures</h1>
<blockquote>
<p>Fixtures are functions that are run by <strong>pytest</strong> before and after the actual test function.</p>
</blockquote>
<p>Use cases: * To get the data for the testfunction * Preparing the system for the test. Like setting up the database etc. * To get the data ready for multiple tests.</p>
<p>Simple fixture</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="at">@pytest.fixture</span>()</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">def</span> some_data():</a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="cf">return</span> <span class="dv">42</span></a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="kw">def</span> test_some_data(some_data):</a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="cf">assert</span> some_data <span class="op">==</span> <span class="dv">42</span></a></code></pre></div>
<p><span class="citation" data-cites="pytest.fixture">@pytest.fixture</span> decorator includes the fixture name in the parameter list of a test function. Fixture will then be called before and optionally after the test function. Fixture can execute some functionality and return some data to the test function.</p>
<p><strong>pytest</strong> will look for the fixture first the test function file and if it is not found then it will look in <strong>conftest.py</strong>. So in order to share fixtures across test functions it has to be provided in conftest.py and doesnt have to be imported in the test function files.</p>
<p>Example showing setup and tear down using pytest fixtures</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="at">@pytest.fixture</span>()</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="kw">def</span> test_fixture():</a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="co"># Setup related logic</span></a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="cf">yield</span> <span class="co"># here the test function will get called</span></a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="co"># Tear down related logic which will be called when the test function is completed.</span></a></code></pre></div>
<h3 id="tracing-fixture-execution">Tracing fixture execution</h3>
<blockquote>
<p>The command line switch –setup-show, shows which fixtures are being used and when and also its scope.</p>
</blockquote>
<h3 id="using-fixture-for-test-data">Using fixture for test data</h3>
<blockquote>
<p>Fixtures can be used to store data needed for testing. Example</p>
</blockquote>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="at">@pytest.fixture</span>()</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw">def</span> a_tuple():</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">    Return a tuple</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="cf">return</span> (<span class="dv">10</span>,<span class="dv">12</span>)</a>
<a class="sourceLine" id="cb8-9" title="9"></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="kw">def</span> test_a_tuple(a_tuple):</a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="cf">assert</span> a_tuple[<span class="dv">1</span>] <span class="op">==</span> <span class="dv">20</span> <span class="co"># This test will fail because 12 != 20</span></a></code></pre></div>
<blockquote>
<p>Note: if an assert happens in the fixture then the test case doesn’t fail but will report an error.</p>
</blockquote>
<h3 id="using-fixture-for-multiple-fixtures">Using fixture for multiple fixtures</h3>
<p>Example</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="at">@pytest.fixture</span>()</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw">def</span> fixture_a():</a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="cf">return</span> {<span class="st">&quot;data&quot;</span> : <span class="dv">12</span>}</a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="at">@pytest.fixture</span>()</a>
<a class="sourceLine" id="cb9-8" title="8"><span class="kw">def</span> fixture_b():</a>
<a class="sourceLine" id="cb9-9" title="9">    <span class="cf">return</span> {<span class="st">&quot;data&quot;</span> : <span class="dv">23</span>}</a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="at">@pytest.fixture</span>()</a>
<a class="sourceLine" id="cb9-12" title="12"><span class="kw">def</span> fixture_ab(fixture_a, fixture_b):</a>
<a class="sourceLine" id="cb9-13" title="13">    <span class="cf">return</span> (fixture_a, fixture_b)</a>
<a class="sourceLine" id="cb9-14" title="14"></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="kw">def</span> test_ab(fixture_ab):</a>
<a class="sourceLine" id="cb9-16" title="16">    <span class="cf">assert</span> fixture_ab[<span class="dv">0</span>][<span class="st">&#39;data&#39;</span>] <span class="op">+</span> fixture_ab[<span class="dv">1</span>][<span class="st">&#39;data&#39;</span>] <span class="op">==</span> <span class="dv">35</span></a></code></pre></div>
<h3 id="fixture-scope">Fixture scope</h3>
<blockquote>
<p>scope parameter of the fixture controls how often a fixture gets set up and torn down. scope can have values of function, class, module and session. And as one might rightly assume function scope calls the fixture for each test function once, class scope will call the fixture once for the test class (i.e. the fixture is shared by all the test functions in the class), module scope will call the fixture once for the module (i.e. the fixture is shared by all the test functions in the module) and session once for the session (i.e the fixture is shared by all the tests in the pytest session).</p>
</blockquote>
<blockquote>
<p>Fixtures can depend only on other fixtures of their same scope or wider.</p>
</blockquote>
<p><strong>tmpdir</strong> and <strong>tmpdir_factory</strong> are builtin fixtures. tmpdir has <em>function</em> scope and tmpdir_factory has <em>session</em> scope. So when you using fixtures with <em>session</em> scope one has to use tmpdir_factory fixture.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" title="1"></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="at">@pytest.fixture</span>(scope <span class="op">=</span> <span class="st">&#39;function&#39;</span>)</a>
<a class="sourceLine" id="cb10-5" title="5"><span class="kw">def</span> fixture_a:</a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="co"># do something</span></a>
<a class="sourceLine" id="cb10-7" title="7">    <span class="cf">return</span></a></code></pre></div>
<h3 id="usefixture-keyword"><strong>usefixture</strong> keyword</h3>
<p>One case mark a test case of test class with fixtures to be used like this</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" title="1"><span class="at">@pytest.mark.usefixtures</span>(<span class="st">&#39;fixture1&#39;</span>, <span class="st">&#39;fixture2&#39;</span>)</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw">class</span> TestSomething():</a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="kw">def</span> test_case1(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb11-4" title="4">        <span class="co">&quot;&quot;&quot;some test&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="kw">def</span> test_case2(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb11-7" title="7">        <span class="co">&quot;&quot;&quot;some other test&quot;&quot;&quot;</span></a></code></pre></div>
<blockquote>
<p>Note one cannot use the return value of the fixture if we use the fixture like this</p>
</blockquote>
<h3 id="autouse-keyword"><strong>autouse</strong> keyword</h3>
<blockquote>
<p>We can use autouse=True to get a fixture to run all the time.</p>
</blockquote>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="at">@pytest.fixture</span>(autouse<span class="op">=</span><span class="va">True</span>):</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="kw">def</span> fixture_a():</a>
<a class="sourceLine" id="cb12-5" title="5">    start <span class="op">=</span> time.time()</a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="cf">yield</span></a>
<a class="sourceLine" id="cb12-7" title="7">    stop <span class="op">=</span> time.time()</a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Time elapsed </span><span class="sc">{</span>stop <span class="op">-</span> start<span class="sc">}</span><span class="ss">&quot;</span>)</a>
<a class="sourceLine" id="cb12-9" title="9"></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="kw">def</span> test_case1():</a>
<a class="sourceLine" id="cb12-11" title="11">    <span class="co">&quot;&quot;&quot;test something&quot;&quot;&quot;</span></a></code></pre></div>
<h3 id="renaming-fixtures">Renaming fixtures</h3>
<p>We can rename a fixture using the <strong>name</strong> parameter to <span class="citation" data-cites="pytest.fixture">@pytest.fixture</span>():</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="at">@pytest.fixture</span>(name<span class="op">=</span><span class="st">&#39;demo&#39;</span>)</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw">def</span> some_long_fixture_name():</a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="cf">return</span> <span class="dv">42</span></a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="kw">def</span> test_demo(demo):</a>
<a class="sourceLine" id="cb13-8" title="8">    <span class="cf">assert</span> demo <span class="op">==</span> <span class="dv">42</span></a></code></pre></div>
<blockquote>
<p>pytest command line option –fixtures lists all the fixtures available for test, including the renamed ones.</p>
</blockquote>
<h3 id="parameterizing-fixtures">Parameterizing fixtures</h3>
<blockquote>
<p>With Parameterized fixtures each test function that uses the fixture will be called as many times as the number of items in the parameter.</p>
</blockquote>
<p>Parameterization of the fixtures is done using the builtin fixture <strong>request</strong>. The list of parameter values should be set to <em>params</em> and the fixture should return <em>param</em> field of <em>request</em> builtin fixture.</p>
<p>Example</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb14-2" title="2"></a>
<a class="sourceLine" id="cb14-3" title="3">data <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]</a>
<a class="sourceLine" id="cb14-4" title="4"></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="at">@pytest.fixture</span>(params <span class="op">=</span> data)</a>
<a class="sourceLine" id="cb14-6" title="6"><span class="kw">def</span> data_fixture(request):</a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co">    parameterized fixture</span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb14-10" title="10">    <span class="cf">return</span> request.param</a>
<a class="sourceLine" id="cb14-11" title="11"></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="kw">def</span> test_even(data_fixture):</a>
<a class="sourceLine" id="cb14-13" title="13">    <span class="cf">assert</span> data_fixture <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span></a></code></pre></div>
<p>If along with the <em>params</em> argument an <em>ids</em> argument is provided which should be a function that provides <strong>id</strong> for each invocation of the fixture or a list of ids. So when pytest is invoked in verbose mode one can see what parameter is passed from the fixture to the test function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">def</span> id_func(item):</a>
<a class="sourceLine" id="cb15-2" title="2">    <span class="cf">return</span> <span class="ss">f&quot;Calling with data: </span><span class="sc">{</span>item<span class="sc">}</span><span class="ss">&quot;</span></a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="at">@pytest.fixture</span>(params<span class="op">=</span>data, ids<span class="op">=</span>id_func)</a>
<a class="sourceLine" id="cb15-5" title="5"><span class="kw">def</span> test_even(data_fixture):</a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="cf">assert</span> data_fixture <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span></a></code></pre></div>
<h1 id="chapter-4---builtin-fixtures">Chapter 4 - Builtin Fixtures</h1>
<h2 id="tmpdir-and-tmpdir_factory">tmpdir and tmpdir_factory</h2>
<ul>
<li>Used to create temporary file and system directory before the test runs and to delete them after the test is finished.</li>
<li>tmpdir fixture has function scope and tmpdir_factory has session scope</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw">def</span> test_something(tmpdir):</a>
<a class="sourceLine" id="cb16-4" title="4">    a_file <span class="op">=</span> tmpdir.join(<span class="st">&#39;somefile&#39;</span>)</a>
<a class="sourceLine" id="cb16-5" title="5">    a_subdir <span class="op">=</span> tmpdir.mkdir(<span class="st">&#39;somedir&#39;</span>)</a>
<a class="sourceLine" id="cb16-6" title="6"></a>
<a class="sourceLine" id="cb16-7" title="7">    <span class="cf">assert</span> testsomething</a></code></pre></div>
<blockquote>
<p>return type of tmpdir is py.path.local This library is in maintenace mode.</p>
</blockquote>
<p>Example of tmpdir_factory</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">def</span> test_somethin_else(tmpdir_factory):</a>
<a class="sourceLine" id="cb17-2" title="2">    a_tmpdir <span class="op">=</span> tmpdir_factory.mktemp(<span class="st">&#39;mydir&#39;</span>)</a>
<a class="sourceLine" id="cb17-3" title="3">    a_file <span class="op">=</span> a_tmpdir.join(<span class="st">&#39;somefile&#39;</span>)</a>
<a class="sourceLine" id="cb17-4" title="4">    a_subdir <span class="op">=</span> a_tmpdir.mkdir(<span class="st">&#39;somedir&#39;</span>)</a>
<a class="sourceLine" id="cb17-5" title="5"></a>
<a class="sourceLine" id="cb17-6" title="6">    <span class="cf">assert</span> testsomething</a></code></pre></div>
<blockquote>
<p>We can set our own base temp directory using the command line option –basetemp=mydir</p>
</blockquote>
<p>As <strong>tmpdir_factory</strong> has session scope, in order to have something for module level scope one has to create a new fixture of module level scope with inturn depend up the tmpdir_factory fixture.</p>
<h2 id="pytestconfig">pytestconfig</h2>
<ul>
<li>It is a shortcut to <em>request.config</em>.</li>
<li>Typical use case is to access custom options of pytest
<ul>
<li>Say you created a new custom option <em>foo</em> using the hook <strong>pytest_addoption</strong>.</li>
<li>You can then access the value of this option in the tests using the fixture pytestconfig</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb18-1" title="1"><span class="co"># In conftest.py</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb18-3" title="3"></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="kw">def</span> pytest_addoption(parser):</a>
<a class="sourceLine" id="cb18-5" title="5">    parser.addoption(<span class="st">&quot;--foo&quot;</span>, action<span class="op">=</span><span class="st">&quot;store&quot;</span>, default<span class="op">=</span><span class="st">&quot;bar&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;foo: bar or baz&quot;</span>)</a>
<a class="sourceLine" id="cb18-6" title="6"></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co">#In some test file</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="kw">def</span> test_something(pytestconfig):</a>
<a class="sourceLine" id="cb18-9" title="9">    <span class="bu">print</span>(<span class="st">&#39;foo is set to &#39;</span>, pytestconfig.getoption(<span class="st">&#39;foo&#39;</span>))</a></code></pre></div>
<blockquote>
<p>One can create new fixtures that depend upon pytestconfig to returon specfic custom option Also note that one can not only access custom options but also the built in options like invocation directory, args, inifile, rootdir etc.</p>
</blockquote>
<h2 id="cache">cache</h2>
<ul>
<li>Fixture about storing information about one test session and retrieving it in the next</li>
<li>Example - Build in functionality of –last-failed and –failed-first</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb19-1" title="1">cache.<span class="bu">set</span>(key, value)</a>
<a class="sourceLine" id="cb19-2" title="2">cache.get(key, default)</a></code></pre></div>
<blockquote>
<p>cache fixture has function scope commad line option to clear cache –cache-clear show the cache from command line using the switch –cache-show</p>
</blockquote>
<h2 id="capsys">capsys</h2>
<ul>
<li>retrieve <em>stdout</em> and <em>stderr</em></li>
<li>disable output capture temporarily</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb20-1" title="1"><span class="im">import</span> python</a>
<a class="sourceLine" id="cb20-2" title="2"></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="kw">def</span> test_capsys_disabled(capsys):</a>
<a class="sourceLine" id="cb20-4" title="4">    <span class="cf">with</span> capsys.disabled():</a>
<a class="sourceLine" id="cb20-5" title="5">        <span class="bu">print</span>(<span class="st">&#39;This will always get printed&#39;</span>)</a>
<a class="sourceLine" id="cb20-6" title="6">    <span class="bu">print</span>(<span class="st">&#39;This will be printed on stdout only when command line opt -s is used&#39;</span>)</a></code></pre></div>
<h2 id="monkeypatch">monkeypatch</h2>
<p>A monkey patch is a dynamic modification of a class or module during run time. What can we do with monkeypatch?</p>
<ul>
<li>setattr</li>
<li>delattr</li>
<li>setitem</li>
<li>delitem</li>
<li>setenv</li>
<li>delenv</li>
<li>syspath_prepend</li>
<li>chdir</li>
</ul>
<h2 id="doctest">doctest</h2>
<p>doctest module of python lets code examples inside docstring and test them. Using –doctest-modules flag pytest can execute doctest tests.</p>
<blockquote>
<p>One other thing thats important to note here is about doctest_namespace Say in the module docstring you have an import statement import import numpy as np And in the subsequent docstrings of function you use np.sum or some other function of numpy The pytest doctest fails. Because pytest considers each doctest as a separate test. To avoid that problem use a fixture with doctest_namespace buitin</p>
</blockquote>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb21-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb21-2" title="2"></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="at">@pytest.fixture</span>(autoreuse<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb21-4" title="4"><span class="kw">def</span> add_np(doctest_namespace):</a>
<a class="sourceLine" id="cb21-5" title="5">    doctest_namespace[<span class="st">&#39;np&#39;</span>] <span class="op">=</span> numpy</a></code></pre></div>
<h2 id="recwarn">recwarn</h2>
<ul>
<li>to examine warnings generated by the code under test</li>
<li>pytest also provides a context manager pytests.warns() which gives a similar functionality</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb22-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb22-2" title="2"><span class="im">import</span> warnings</a>
<a class="sourceLine" id="cb22-3" title="3"></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="kw">def</span> test_something(recwarn):</a>
<a class="sourceLine" id="cb22-5" title="5">    w <span class="op">=</span> recwarn.pop()</a>
<a class="sourceLine" id="cb22-6" title="6">    <span class="cf">assert</span> w.category <span class="op">==</span> <span class="pp">DeprecationWarning</span></a></code></pre></div>
<p>Similar functionality using pytest.warns()</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb23-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb23-2" title="2"></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">def</span> test_something():</a>
<a class="sourceLine" id="cb23-4" title="4">    <span class="cf">with</span> pytest.warns() <span class="im">as</span> warning_list:</a>
<a class="sourceLine" id="cb23-5" title="5">        somefunction()</a>
<a class="sourceLine" id="cb23-6" title="6"></a>
<a class="sourceLine" id="cb23-7" title="7">    w <span class="op">=</span> warning_list.pop()</a>
<a class="sourceLine" id="cb23-8" title="8">    <span class="cf">assert</span> w.category <span class="op">==</span> <span class="pp">DeprecationWarning</span></a></code></pre></div>
<h1 id="chapter-5---plugins">Chapter 5 - Plugins</h1>
<h2 id="finding-plugins">Finding Plugins</h2>
<ul>
<li>@ docs.pytest.org</li>
<li>@ pypi.python.org</li>
<li>@ github.com/pytest-dev</li>
</ul>
<h2 id="installing-plugins">Installing Plugins</h2>
<blockquote>
<p>Plugins are installed using <strong>pip</strong></p>
<p>Examples: pip install pytest-cov pip install pytest-cov==2.4.0</p>
</blockquote>
<h2 id="writing-your-own-plugins">Writing your own plugins</h2>
<ul>
<li>Fixtures that can be shared across projects can be packaged into a plugin.</li>
<li>Hooks which will alter the way pytest behaves can also be packaged into a plugin.</li>
</ul>
<p>The hook function <strong>pytest_report_teststatus()</strong> changes the test status</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb24-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb24-2" title="2"></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="kw">def</span> pytest_report_teststatus(report):</a>
<a class="sourceLine" id="cb24-4" title="4">    <span class="cf">if</span> report.when <span class="op">==</span> <span class="st">&#39;call&#39;</span>:</a>
<a class="sourceLine" id="cb24-5" title="5">        <span class="cf">if</span> report.failed <span class="kw">and</span> pytest.config.getoption(<span class="st">&#39;nice&#39;</span>):</a>
<a class="sourceLine" id="cb24-6" title="6">            <span class="cf">return</span> (report.outcome, <span class="st">&#39;O&#39;</span>, <span class="st">&#39;OPPORTUNITY for improvement&#39;</span>)</a></code></pre></div>
<blockquote>
<p>The above hook function will set the status of test on fail as ‘O’ instead of ‘F’ and in verbose will show ‘OPPORTUNITY for improvement’, if pytest is called with the option –nice.</p>
</blockquote>
<h3 id="installable-plugin.">Installable plugin.</h3>
<p>Example building a plugin with command line option –nice: Create the following folder structure pytest.nice |– LICENCE |– README.rst |– pytest_nice.py |– setup.py |– tests |– conftest.py |– test_nice.py</p>
<p>pytest_nice.py:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb25-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb25-2" title="2"></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="kw">def</span> pytest_addoption(parser):</a>
<a class="sourceLine" id="cb25-4" title="4">    group <span class="op">=</span> parser.getgroup(<span class="st">&#39;nice&#39;</span>)</a>
<a class="sourceLine" id="cb25-5" title="5">    group.addoption(<span class="st">&quot;--nice&quot;</span>, action <span class="op">=</span> <span class="st">&quot;store_true&quot;</span>)</a></code></pre></div>
<h1 id="chapter-6---configuration">Chapter 6 - Configuration</h1>
<ul>
<li>pytest.ini - primary configuration file</li>
<li>conftest.py - local plugin to allow hook functions and fixtures.</li>
<li><strong>init</strong>.py - when put in test sub directories, this file allows you to have identical test file names in multiple test directories. (think of namespace.)</li>
</ul>
<p>What can you do?</p>
<ul>
<li>Change the default command line options.</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">[pytest]</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="dt">addopts </span><span class="ot">=</span><span class="st"> -rsxX -l --tb=short --strict</span></a></code></pre></div>
<ul>
<li>Registering Markers to Avoid Marker Typos Registering markers in the ini file and combining with the command line option –strict=true, we can avoid misspelled markers. pytest will throw an error if it finds an unregistered marker.</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">[pytest]</span></a>
<a class="sourceLine" id="cb27-2" title="2"><span class="dt">markers </span><span class="ot">=</span></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="dt">    smoke: Run the smoke test functions</span></a>
<a class="sourceLine" id="cb27-4" title="4"><span class="dt">    get: Run the get test functions</span></a></code></pre></div>
<p>The registered markers can be listed with the command <code>pytest --markers</code></p>
<ul>
<li>Requiring a minimum pytest version</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">[pytest]</span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="dt">minversion </span><span class="ot">=</span><span class="st"> </span><span class="fl">3.0</span></a></code></pre></div>
<ul>
<li>Stopping pytest from looking in the wrong places. Specify the folders that has to be skipped for finding test cases as shown below</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">[pytest]</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="dt">norecursedirs </span><span class="ot">=</span><span class="st"> .* dist build</span></a></code></pre></div>
<ul>
<li>Specifying the test directory locations. Specify the test directory with <em>testpaths</em>. Folders relative to the root path will be then searched for test files.</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">[pytest]</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="dt">testpaths </span><span class="ot">=</span><span class="st"> tests</span></a></code></pre></div>
<ul>
<li>Changing Test Discovery Rules. One can specify the pattern for python classes, python files, and python functions using the params <em>python_classes</em>, <em>python_files</em> and <em>python_functions</em> respectively</li>
</ul>
<p>For example, the below setting will make pytest to consider the functions whose name start with <em>check_</em> also as test functions.</p>
<pre><code>[pytest]
python_functions = test_* check_*</code></pre>
<ul>
<li><p>Disallowing XPASS Setting <em>xfail_strict=true</em> will report the tests that are marked with <em><span class="citation" data-cites="pytest.mark.xfail">@pytest.mark.xfail</span></em> as an error.</p></li>
<li><p>Allowing Filename collisions Having <strong><strong>init</strong>.py</strong> files in each sub directory of tests will then allow samefile names for the test modules. i.e. folder1/test_foo.py and folder2/test_foo.py will work if there is <strong>init</strong>.py file in both folder1 and folder2</p></li>
</ul>
<h1 id="chapter-7---using-pytest-with-other-tools">Chapter 7 - Using pytest with other tools</h1>
<ul>
<li>Command line option –pdb will open a pdb debugging session at the point of failure.
<ul>
<li>p/print expr: Prints the value of exp.</li>
<li>q/quit: Quits the debugging session.</li>
<li>pp expr: Pretty prints the value of expr.</li>
<li>l/list: Lists the point of failure and five lines of code above and below.</li>
<li>l/list begin,end: Lists specific line numbers.</li>
<li>a/args: Prints the arguments of the current function with their values. (This is helpful when in a test helper function.)</li>
<li>u/up: Moves up one level in the stack trace.</li>
<li>d/down: Moves down one level in the stack trace.</li>
</ul></li>
<li>Code coverage can be determined using the plugin <em>pytest-cov</em> for <em>coverage.py</em></li>
<li>mock package is shipped as part of the python standard library as unittest-mock. The plugin <em>pytest-mock</em> can be used.</li>
<li>tox is a command line tool that allows you to run complete suite of tests in multiple environments. All the configuration needed for tox will gointo the file tox.ini</li>
<li>Jenkins CI - automating your automated tests. following plugins might be useful ** build-name-setter - sets the display name of the build ** Test Results Analyzer Plugin - shows the history of test execution results in a tabular or graphical format.</li>
<li>unittest - ** pytest markers can be used on unittest test cases ** beware of the setup and teardown function of test cases that are shared between pytest and unittest. ** cannot use parameterized fixtures with unittest.</li>
</ul>
</body>
</html>
